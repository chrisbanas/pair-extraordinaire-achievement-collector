name: Automate Pair Extraordinaire

on:
  workflow_dispatch:

jobs:
  coauthored-prs:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Ensure the dev branch exists and sync with the remote
      - name: Ensure Dev Branch Exists and Sync
        run: |
          if git ls-remote --exit-code --heads origin dev; then
            # Branch exists on remote, fetch and check it out
            git fetch origin dev
            git checkout dev
            git reset --hard origin/dev
          else
            # Branch does not exist, create and push it
            git checkout -b dev
            git push -u origin dev
          fi

      # Set up Git configuration
      - name: Set Up Git
        run: |
          git config --global user.name "Chris Banas"
          git config --global user.email "bananas595@gmail.com"

      # Automate Coauthored PRs
      - name: Automate Coauthored PRs
        env:
          COAUTHOR_NAME: "cblogik"
          COAUTHOR_EMAIL: "cbanas@logik.io"
        run: |
          for i in {1..48}
          do
            branch_name="automated-branch-$i"
            tracker_file="coauthored_merged_prs.txt"

            # Create a new branch
            git checkout -b $branch_name

            # Update or initialize the tracker file
            if [ -f "$tracker_file" ]; then
              current_count=$(grep -oP '\d+' $tracker_file || echo 0)
              new_count=$((current_count + 1))
            else
              new_count=1
            fi

            echo "Coauthored merged pull request #: $new_count" > $tracker_file

            # Commit the change with co-authorship
            git add $tracker_file
            git commit -m "Update coauthored PR count to #$new_count

            Co-authored-by: ${COAUTHOR_NAME} <${COAUTHOR_EMAIL}>
            Co-authored-by: Chris Banas <bananas595@gmail.com>" \
              --author "Chris Banas <bananas595@gmail.com>"

            # Push the branch
            git push origin $branch_name

            # Fetch and update the main branch
            git fetch origin main
            git checkout main

            # Merge the feature branch locally
            git merge --no-ff $branch_name -m "Merge branch '$branch_name' into main"

            # Push the updated main branch
            git push origin main

            # Delete the branch locally and remotely
            git branch -d $branch_name
            git push origin --delete $branch_name

            # Optional: Sleep to avoid rate limits or conflicts
            sleep $((RANDOM % 3 + 1))
          done
