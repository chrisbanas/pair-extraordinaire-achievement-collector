name: Automate Pair Extraordinaire Badge

on:
  workflow_dispatch:

permissions:
  contents: write   # needed for checkout and push
  pull-requests: write

jobs:
  unlock-badge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Git user
        run: |
          git config --global user.name "chrisbanas"
          git config --global user.email "bananas595@gmail.com"

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${GH_TOKEN}" | gh auth login --with-token

      - name: Create and merge 48 co-authored PRs
        env:
          COAUTHOR_NAME: "DongwanSummerXu"
          COAUTHOR_EMAIL: "dongwanxu23@gmail.com"
        run: |
          for i in $(seq 1 48); do
            branch="pair-badge-$i"
            git checkout -b "$branch"

            git commit --allow-empty \
              -m "chore: badge commit #$i" \
              -m "Co-authored-by: ${COAUTHOR_NAME} <${COAUTHOR_EMAIL}>" \
              -m "Co-authored-by: chrisbanas <bananas595@gmail.com>"

            git push -u origin "$branch"

            pr_url=$(gh pr create \
              --title "Automated co-authored PR #$i" \
              --body "This PR is co-authored to unlock the Pair Extraordinaire badge." \
              --head "$branch" \
              --base main)

            gh pr merge "$pr_url" --squash --delete-branch --admin
          done
