name: Automate Pair Extraordinaire Badge

on:
  workflow_dispatch:

permissions:
  contents: write       # for pushing commits
  pull-requests: write  # for creating & merging PRs

jobs:
  unlock-badge:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Ensure dev branch
        run: |
          git fetch origin dev || true
          if git show-ref --verify --quiet refs/remotes/origin/dev; then
            git checkout dev
            git reset --hard origin/dev
          else
            git checkout main
            git checkout -b dev
            git push -u origin dev
          fi

      - name: Set up Git user
        run: |
          git config --global user.name "chrisbanas"
          git config --global user.email "bananas595@gmail.com"

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        env:
          TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          unset GH_TOKEN
          echo "$TOKEN" | gh auth login --with-token

      - name: Create & merge 48 co-authored PRs
        env:
          COAUTHOR_NAME: "DongwanSummerXu"
          COAUTHOR_EMAIL: "dongwanxu23@gmail.com"
        run: |
          for i in $(seq 1 48); do
            # 1) Make a trivial change
            echo "BADGE_RUN_$i=unlock_pair_badge" >> .envexample
            git add .envexample

            # 2) Commit with two Co-authored-by trailers
            git commit -m "chore: badge change #$i" \
                       -m "Co-authored-by: ${COAUTHOR_NAME} <${COAUTHOR_EMAIL}>" \
                       -m "Co-authored-by: chrisbanas <bananas595@gmail.com>"

            git push origin dev

            # 3) Find or create the PR devâ†’main
            pr_number=$(gh pr list \
                          --head dev --base main --state open \
                          --json number --jq '.[0].number // ""')
            if [ -z "$pr_number" ]; then
              pr_number=$(gh pr create \
                            --head dev --base main \
                            --title "Automated co-authored PR #$i" \
                            --body "Co-authored change #$i to unlock the Pair Extraordinaire badge.")
            fi

            # 4) Merge with a real merge commit (keeps the co-authored trailers intact)
            gh pr merge "$pr_number" --merge --admin

            # small sleep to avoid any rate-limit hiccups
            sleep $((RANDOM % 3 + 1))
          done
